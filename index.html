<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="theme-color" content="#0b0f19" />
  <link rel="manifest" href="manifest.json">
  <title>Log Muscu</title>
  <style>
    :root{
      --bg:#0b0f19; --card:#121a2b; --muted:#9aa6c3; --text:#eaf0ff;
      --input:#fff2cc; --auto:#e7f3ff; --ok:#b7f7c8; --warn:#ffe3ad; --bad:#ffb3b3;
      --accent:#7aa8ff; --r:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:-apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background:linear-gradient(180deg,#0b0f19,#070a12);
      color:var(--text);
      padding:14px 14px 90px;
    }
    header{
      position:sticky; top:0; z-index:10;
      background:rgba(11,15,25,.88);
      backdrop-filter: blur(10px);
      padding:10px 10px 12px;
      border-radius: var(--r);
      border:1px solid rgba(255,255,255,.06);
    }
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .pill{
      font-size:12px; color:var(--muted); border:1px solid rgba(255,255,255,.10);
      padding:6px 10px; border-radius:999px;
    }
    select, button, input[type="number"]{font:inherit}
    select{
      background:rgba(255,255,255,.08); color:var(--text);
      border:1px solid rgba(255,255,255,.12);
      padding:10px 12px; border-radius:14px;
      min-width: 130px;
    }
    button{
      background:rgba(122,168,255,.16);
      color:var(--text);
      border:1px solid rgba(122,168,255,.35);
      padding:10px 12px; border-radius:14px;
      font-weight:800;
    }
    button.ghost{
      background:transparent;
      border:1px solid rgba(255,255,255,.12);
      color:var(--text);
    }
    button.danger{
      background:rgba(255,80,80,.14);
      border-color:rgba(255,80,80,.35);
    }
    button:disabled{
      opacity:.45;
    }
    .hint{font-size:12px; color:var(--muted); margin-top:8px; line-height:1.35}
    .card{
      margin-top:12px;
      background:rgba(18,26,43,.92);
      border:1px solid rgba(255,255,255,.06);
      border-radius: var(--r);
      padding:12px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    .cardTitle{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      margin-bottom:10px;
    }
    .cardTitle strong{font-size:14px}
    .small{font-size:12px; color:var(--muted)}
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    .field{
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.08);
      border-radius: 16px;
      padding:10px;
    }
    .field label{
      display:block; font-size:12px; color:var(--muted); margin-bottom:6px;
    }
    .num{
      width:100%;
      padding:14px 12px;
      border-radius: 14px;
      border:1px solid rgba(0,0,0,.08);
      background:var(--input);
      color:#111;
      font-size:18px;
      font-weight:900;
      text-align:center;
      outline:none;
    }
    .num:focus{box-shadow:0 0 0 3px rgba(122,168,255,.35)}
    .autoBox{
      background:var(--auto);
      color:#111;
      border-radius:16px;
      padding:10px;
      border:1px solid rgba(0,0,0,.07);
    }
    .autoBox .k{font-size:12px; opacity:.75}
    .autoBox .v{font-size:18px; font-weight:900; margin-top:2px}
    .action{
      margin-top:10px;
      padding:14px 12px;
      border-radius:16px;
      font-weight:900;
      font-size:16px;
      text-align:center;
      border:1px solid rgba(0,0,0,.10);
      user-select:none;
    }
    .action.ok{background:var(--ok); color:#0b3a17}
    .action.warn{background:var(--warn); color:#4a2b00}
    .action.bad{background:var(--bad); color:#4a0000}
    .toolbar{
      position:fixed; left:0; right:0; bottom:0;
      padding:12px 14px calc(12px + env(safe-area-inset-bottom));
      background:rgba(11,15,25,.90);
      backdrop-filter: blur(10px);
      border-top:1px solid rgba(255,255,255,.08);
      display:flex; gap:10px; justify-content:space-between; align-items:center;
    }
    .toolbar button{flex:1}
    .exList{margin-top:10px; display:flex; flex-direction:column; gap:10px}
    canvas{width:100%; height:180px; background:rgba(255,255,255,.04); border-radius:16px; border:1px solid rgba(255,255,255,.06)}
    .legend{display:flex; gap:10px; flex-wrap:wrap; margin-top:8px; color:var(--muted); font-size:12px}
    .dot{display:inline-block; width:10px; height:10px; border-radius:999px; vertical-align:middle; margin-right:6px}
  </style>
</head>
<body>

<header>
  <!-- Header compact : date -->
  <div class="row" style="justify-content:flex-end">
    <span class="pill" id="todayPill"></span>
  </div>

  <!-- Navigation -->
  <div class="row" style="margin-top:10px">
    <select id="sessionSelect">
      <option value="Haut A">Haut A</option>
      <option value="Haut B">Haut B</option>
      <option value="Bas A">Bas A</option>
      <option value="Bas B">Bas B</option>
    </select>

    <button class="ghost" id="toWorkoutBtn">‚¨ÖÔ∏è S√©ance</button>
    <button class="ghost" id="homeBtn">üè†</button>
    <button class="ghost" id="statsBtn">üìà</button>
    <button class="ghost" id="settingsBtn">‚öôÔ∏è</button>

    <!-- Mini chrono (repos) -->
<span id="timerWrap" class="row" style="gap:6px">
  <button class="ghost" id="t30" style="padding:10px 10px">30s</button>
  <button class="ghost" id="t60" style="padding:10px 10px">1m</button>
  <button class="ghost" id="t120" style="padding:10px 10px">2m</button>

  <button class="ghost" id="timerDisplay" style="display:none; padding:10px 12px; min-width:72px; text-align:center; font-weight:900">
    00:00
  </button>
</span>

    
    <button id="newWorkoutBtn">+ Nouvelle</button>
  </div>
</header>

<div id="main"></div>

<div class="toolbar" id="toolbar">
  <button id="saveBtn">üíæ Sauver</button>
  <button class="ghost" id="exportBtn">‚¨áÔ∏è Export</button>
  <button class="ghost" id="importBtn">‚¨ÜÔ∏è Import</button>
</div>

<script>
/** =========================
 *  Stockage (offline)
 *  ========================= */
const KEY = "log_muscu_v1";

const SESSIONS = ["Haut A","Haut B","Bas A","Bas B"];

const defaultExercises = {
  "Haut A": ["D√©velopp√© couch√©", "Rowing", "D√©velopp√© √©paules", "Tractions", "Curl"],
  "Haut B": ["D√©velopp√© inclin√©", "Tirage vertical", "Dips", "Oiseau", "Curl inclin√©"],
  "Bas A": ["Squat", "Soulev√© de terre JT", "Presse", "Leg curl", "Mollets"],
  "Bas B": ["Front squat", "Hip thrust", "Fentes", "Leg extension", "Mollets"]
};

function loadDB(){
  const raw = localStorage.getItem(KEY);
  if(!raw){
    const db = { exercises: defaultExercises, workouts: [] };
    localStorage.setItem(KEY, JSON.stringify(db));
    return db;
  }
  try { return JSON.parse(raw); } catch(e){
    const db = { exercises: defaultExercises, workouts: [] };
    localStorage.setItem(KEY, JSON.stringify(db));
    return db;
  }
}
function saveDB(db){ localStorage.setItem(KEY, JSON.stringify(db)); }

let db = loadDB();

/** =========================
 *  Helpers progression
 *  ========================= */
function totalReps(sets, use3=false){
  const arr = use3 ? sets.slice(0,3) : sets;
  return arr.reduce((a,b)=>a+(Number(b||0)),0);
}
function volume(sets, w, use3=false){
  return totalReps(sets, use3) * Number(w||0);
}
function actionFor(sets, use3=false){
  const t = totalReps(sets, use3);
  const max = use3 ? 30 : 40; // 3x10 vs 4x10
  const min = use3 ? 18 : 24; // 3x6 vs 4x6

  if(t >= max) return { text:"‚¨ÜÔ∏è AUGMENTER LA CHARGE", cls:"ok" };
  if(t >= min) return { text:"‚û°Ô∏è AJOUTER DES REPS", cls:"warn" };
  return { text:"‚¨áÔ∏è TROP LOURD / AJUSTER", cls:"bad" };
}
function fmt(n){ return (Math.round(n*100)/100).toString(); }
function todayStr(){
  const d = new Date();
  return d.toLocaleDateString("fr-FR", { weekday:"short", year:"numeric", month:"short", day:"numeric" });
}
document.getElementById("todayPill").textContent = todayStr();

/** =========================
 *  UI State
 *  ========================= */
const main = document.getElementById("main");
const sessionSelect = document.getElementById("sessionSelect");

const toWorkoutBtn = document.getElementById("toWorkoutBtn");
const homeBtn = document.getElementById("homeBtn");
const statsBtn = document.getElementById("statsBtn");
const settingsBtn = document.getElementById("settingsBtn");
const newWorkoutBtn = document.getElementById("newWorkoutBtn");

let view = "home"; // home | workout | stats | settings
let currentWorkoutId = null;

/** =========================
 *  Workouts helpers
 *  ========================= */
function newWorkout(session){
  const exs = (db.exercises[session] || []).slice(0);
  const workout = {
    id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now()),
    session,
    date: new Date().toISOString(),
    entries: exs.map(name => ({
      name,
      sets: [null,null,null,null],
      use3: false,
      weight: null
    }))
  };
  db.workouts.unshift(workout);
  saveDB(db);
  currentWorkoutId = workout.id;
  return workout;
}

function getWorkout(){
  if(!db.workouts.length){
    // default create for first use
    newWorkout("Haut A");
  }
  if(!currentWorkoutId){
    currentWorkoutId = db.workouts[0].id;
  }
  return db.workouts.find(w => w.id === currentWorkoutId) || db.workouts[0];
}

// last workout for a session
function openLastWorkoutForSession(session){
  const found = db.workouts.find(w => w.session === session);
  if(found){
    currentWorkoutId = found.id;
    return found;
  }
  return newWorkout(session);
}

function setView(v){ view = v; render(); }

/** =========================
 *  Nav / Buttons
 *  ========================= */
homeBtn.addEventListener("click", () => setView("home"));
statsBtn.addEventListener("click", () => setView("stats"));
settingsBtn.addEventListener("click", () => setView("settings"));
toWorkoutBtn.addEventListener("click", () => setView("workout"));

newWorkoutBtn.addEventListener("click", () => {
  // create a new workout for the currently selected session
  openLastWorkoutForSession(sessionSelect.value);
  newWorkout(sessionSelect.value);
  setView("workout");
});

// session select opens last workout of that session (or creates)
sessionSelect.addEventListener("change", () => {
  openLastWorkoutForSession(sessionSelect.value);
  setView("workout");
});

/** =========================
 *  Save / Export / Import
 *  ========================= */
document.getElementById("saveBtn").addEventListener("click", () => {
  saveDB(db);
  toast("Sauv√© ‚úÖ");
});
document.getElementById("exportBtn").addEventListener("click", () => exportJSON());
document.getElementById("importBtn").addEventListener("click", () => importJSON());

function toast(msg){
  const t = document.createElement("div");
  t.textContent = msg;
  t.style.position="fixed";
  t.style.left="50%";
  t.style.bottom="92px";
  t.style.transform="translateX(-50%)";
  t.style.background="rgba(0,0,0,.75)";
  t.style.border="1px solid rgba(255,255,255,.15)";
  t.style.color="white";
  t.style.padding="10px 14px";
  t.style.borderRadius="999px";
  t.style.zIndex="999";
  document.body.appendChild(t);
  setTimeout(()=>t.remove(), 1200);
}

function exportJSON(){
  saveDB(db);
  const blob = new Blob([JSON.stringify(db, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "log_muscu_backup.json";
  a.click();
  URL.revokeObjectURL(url);
}

function importJSON(){
  const inp = document.createElement("input");
  inp.type="file";
  inp.accept="application/json";
  inp.onchange = async () => {
    const file = inp.files[0];
    if(!file) return;
    const text = await file.text();
    try{
      const parsed = JSON.parse(text);
      if(!parsed.workouts || !parsed.exercises) throw new Error("format");
      db = parsed;
      saveDB(db);
      currentWorkoutId = db.workouts[0]?.id || null;
      toast("Import OK ‚úÖ");
      render();
    }catch(e){
      toast("Import impossible ‚ùå");
    }
  };
  inp.click();
}

/** =========================
 *  Views
 *  ========================= */
function renderHome(){
  // set select to last used session if possible
  const last = db.workouts[0]?.session || "Haut A";
  sessionSelect.value = last;

  const wrap = document.createElement("div");
  wrap.className = "card";
  wrap.innerHTML = `
    <div class="cardTitle">
      <div>
        <strong>Choisir une s√©ance</strong>
        <div class="small">Haut x2 / Bas x2 ‚Äî double progression</div>
      </div>
      <span class="pill">${todayStr()}</span>
    </div>
    <div class="hint">Tape une s√©ance pour ouvrir la derni√®re (ou cr√©er la premi√®re).</div>
  `;

  const list = document.createElement("div");
  list.className = "exList";

  SESSIONS.forEach(s => {
    const b = document.createElement("button");
    b.className = "ghost";
    b.style.width = "100%";
    b.style.padding = "14px 12px";
    const lastW = db.workouts.find(w => w.session === s);
    const suffix = lastW ? (" ‚Äî " + new Date(lastW.date).toLocaleDateString("fr-FR",{month:"short",day:"numeric"})) : " ‚Äî (nouveau)";
    b.textContent = `‚ñ∂Ô∏è ${s}${suffix}`;
    b.onclick = () => {
      sessionSelect.value = s;
      openLastWorkoutForSession(s);
      setView("workout");
    };
    list.appendChild(b);
  });

  wrap.appendChild(list);
  main.replaceChildren(wrap);
}

function renderWorkout(){
  const w = getWorkout();
  sessionSelect.value = w.session;

  const date = new Date(w.date).toLocaleString("fr-FR", {
    year:"numeric", month:"short", day:"numeric", hour:"2-digit", minute:"2-digit"
  });

  const wrapper = document.createElement("div");
  wrapper.className = "card";

  const top = document.createElement("div");
  top.className = "cardTitle";
  top.innerHTML = `
    <div>
      <strong>üìÖ ${w.session}</strong>
      <div class="small">${date}</div>
    </div>
    <button class="danger" id="delBtn">Supprimer</button>
  `;
  wrapper.appendChild(top);

  setTimeout(() => {
    const delBtn = document.getElementById("delBtn");
    if(delBtn){
      delBtn.onclick = () => {
        db.workouts = db.workouts.filter(x => x.id !== w.id);
        currentWorkoutId = db.workouts[0]?.id || null;
        saveDB(db);
        render();
      };
    }
  }, 0);

  // List of exercises
  const list = document.createElement("div");
  list.className = "exList";

  w.entries.forEach((e, idx) => {
    const card = document.createElement("div");
    card.className = "card";

    const title = document.createElement("div");
    title.className = "cardTitle";
    title.innerHTML = `
      <div>
        <strong>${e.name}</strong>
        <div class="small">Reps & charge uniquement</div>
      </div>
      <button class="danger" style="padding:8px 10px;border-radius:12px;">‚úï</button>
    `;
    title.querySelector("button").onclick = () => {
      if(!confirm("Supprimer cet exercice ?")) return;
      w.entries.splice(idx,1);
      saveDB(db);
      render();
    };
    card.appendChild(title);

    // Toggle 3/4 series
    const toggleRow = document.createElement("div");
    toggleRow.className = "row";
    toggleRow.style.justifyContent = "space-between";
    toggleRow.style.marginBottom = "8px";
    toggleRow.innerHTML = `
      <span class="small">Format</span>
      <button class="ghost">${e.use3 ? "3 s√©ries ‚úÖ" : "4 s√©ries"}</button>
    `;
    toggleRow.querySelector("button").onclick = () => {
      e.use3 = !e.use3;
      if(e.use3) e.sets[3] = null;
      saveDB(db);
      render();
    };
    card.appendChild(toggleRow);

    // Sets
    const grid = document.createElement("div");
    grid.className = "grid";
    ["S1","S2","S3","S4"].forEach((lab, s) => {
      if(e.use3 && s === 3) return;
      const f = document.createElement("div");
      f.className = "field";
      f.innerHTML = `<label>${lab} (reps)</label>`;
      const inp = document.createElement("input");
      inp.type = "number";
      inp.inputMode = "numeric";
      inp.placeholder = "‚Äî";
      inp.value = (e.sets[s] ?? "");
      inp.className = "num";
      inp.oninput = () => {
        e.sets[s] = inp.value === "" ? null : Number(inp.value);
        updateEntryUI(card, e);
        saveDB(db);
      };
      f.appendChild(inp);
      grid.appendChild(f);
    });
    card.appendChild(grid);

    // Weight
    const weightField = document.createElement("div");
    weightField.className = "field";
    weightField.style.marginTop = "10px";
    weightField.innerHTML = `<label>Charge (kg)</label>`;
    const winp = document.createElement("input");
    winp.type="number";
    winp.inputMode="decimal";
    winp.step="0.5";
    winp.placeholder="‚Äî";
    winp.value = (e.weight ?? "");
    winp.className="num";
    winp.oninput = () => {
      e.weight = winp.value === "" ? null : Number(winp.value);
      updateEntryUI(card, e);
      saveDB(db);
    };
    weightField.appendChild(winp);
    card.appendChild(weightField);

    // Auto stats
    const autoWrap = document.createElement("div");
    autoWrap.style.display="grid";
    autoWrap.style.gridTemplateColumns="1fr 1fr";
    autoWrap.style.gap="10px";
    autoWrap.style.marginTop="10px";

    autoWrap.innerHTML = `
      <div class="autoBox">
        <div class="k">Total reps</div>
        <div class="v" data-k="total">0</div>
      </div>
      <div class="autoBox">
        <div class="k">Volume</div>
        <div class="v" data-k="vol">0</div>
      </div>
    `;
    card.appendChild(autoWrap);

    // Action
    const act = document.createElement("div");
    act.className = "action warn";
    act.dataset.k = "action";
    card.appendChild(act);

    // Target hint
    const target = document.createElement("div");
    target.className = "hint";
    target.dataset.k = "target";
    target.style.marginTop = "8px";
    card.appendChild(target);

    updateEntryUI(card, e);
    list.appendChild(card);
  });

  wrapper.appendChild(list);

  // Add exercise (BOTTOM)
  const addRow = document.createElement("div");
  addRow.className = "card";
  addRow.innerHTML = `<button class="ghost" style="width:100%">‚ûï Ajouter un exercice</button>`;
  addRow.querySelector("button").onclick = () => {
    const name = prompt("Nom de l'exercice ?");
    if(!name) return;
    w.entries.push({ name, sets:[null,null,null,null], use3:false, weight:null });
    saveDB(db);
    render();
  };
  wrapper.appendChild(addRow);

  // History
  const histWrap = document.createElement("div");
  histWrap.className = "card";
  histWrap.innerHTML = `<div class="cardTitle"><div><strong>üóÉ Historique</strong><div class="small">Tape pour ouvrir une s√©ance pass√©e</div></div></div>`;
  const hist = document.createElement("div");
  hist.className = "exList";

  db.workouts.slice(0, 8).forEach(x => {
    const b = document.createElement("button");
    b.className = "ghost";
    const xd = new Date(x.date).toLocaleDateString("fr-FR", { month:"short", day:"numeric" });
    b.textContent = `${x.session} ‚Äî ${xd}`;
    b.onclick = () => { currentWorkoutId = x.id; setView("workout"); };
    hist.appendChild(b);
  });
  histWrap.appendChild(hist);

  main.replaceChildren(wrapper, histWrap);
}

function updateEntryUI(cardEl, entry){
  const t = totalReps(entry.sets, entry.use3);
  const vol = volume(entry.sets, entry.weight, entry.use3);
  const act = actionFor(entry.sets, entry.use3);

  cardEl.querySelector('[data-k="total"]').textContent = fmt(t);
  cardEl.querySelector('[data-k="vol"]').textContent = fmt(vol);

  const actionEl = cardEl.querySelector('[data-k="action"]');
  actionEl.textContent = act.text;
  actionEl.classList.remove("ok","warn","bad");
  actionEl.classList.add(act.cls);

  const targetEl = cardEl.querySelector('[data-k="target"]');
  if(act.cls === "ok"){
    targetEl.textContent = "üéØ Prochaine s√©ance : augmente la charge (au choix) et repars vers ~6 reps.";
  } else if(act.cls === "warn"){
    targetEl.textContent = "üéØ Prochaine s√©ance : garde la charge et essaie d'ajouter 1 rep.";
  } else {
    targetEl.textContent = "üéØ Prochaine s√©ance : baisse l√©g√®rement la charge ou am√©liore la forme.";
  }
}

function renderSettings(){
  const s = sessionSelect.value;
  const wrap = document.createElement("div");
  wrap.className = "card";
  wrap.innerHTML = `
    <div class="cardTitle">
      <div><strong>‚öôÔ∏è Exercices</strong><div class="small">1 ligne = 1 exercice (par s√©ance)</div></div>
      <span class="pill">${s}</span>
    </div>
  `;

  const textarea = document.createElement("textarea");
  textarea.style.width="100%";
  textarea.style.minHeight="220px";
  textarea.style.marginTop="10px";
  textarea.style.padding="12px";
  textarea.style.borderRadius="16px";
  textarea.style.border="1px solid rgba(255,255,255,.12)";
  textarea.style.background="rgba(255,255,255,.08)";
  textarea.style.color="var(--text)";
  textarea.style.fontSize="14px";
  textarea.value = (db.exercises[s] || []).join("\n");

  const saveBtn = document.createElement("button");
  saveBtn.style.marginTop="10px";
  saveBtn.textContent = "Enregistrer";
  saveBtn.onclick = () => {
    const lines = textarea.value.split("\n").map(x=>x.trim()).filter(Boolean);
    db.exercises[s] = lines;
    saveDB(db);
    toast("Exercices enregistr√©s ‚úÖ");
  };

  const note = document.createElement("div");
  note.className = "hint";
  note.textContent = "La liste s'applique aux nouvelles s√©ances (+ Nouvelle).";

  wrap.append(textarea, saveBtn, note);
  main.replaceChildren(wrap);
}

function renderStats(){
  const session = sessionSelect.value;

  const wrap = document.createElement("div");
  wrap.className = "card";
  wrap.innerHTML = `
    <div class="cardTitle">
      <div><strong>üìà Progression</strong><div class="small">${session} ‚Äî charge & volume</div></div>
      <span class="pill">Offline</span>
    </div>
  `;

  const ws = db.workouts
    .filter(w => w.session === session)
    .slice(0, 20)
    .reverse();

  const labels = ws.map(w => new Date(w.date).toLocaleDateString("fr-FR", {month:"short", day:"numeric"}));
  const volumes = ws.map(w => w.entries.reduce((acc,e)=>acc + volume(e.sets,e.weight,e.use3), 0));
  const maxW = ws.map(w => Math.max(0, ...w.entries.map(e=>Number(e.weight||0))));

  const c1 = document.createElement("canvas");
  const c2 = document.createElement("canvas");

  const leg = document.createElement("div");
  leg.className = "legend";
  leg.innerHTML = `
    <span><span class="dot" style="background:#7aa8ff"></span>Charge max</span>
    <span><span class="dot" style="background:#ffd36a"></span>Volume</span>
  `;

  wrap.appendChild(c1);
  wrap.appendChild(leg);
  wrap.appendChild(c2);

  function drawLine(canvas, series, color){
    const ctx = canvas.getContext("2d");
    const W = canvas.width = canvas.clientWidth * devicePixelRatio;
    const H = canvas.height = canvas.clientHeight * devicePixelRatio;
    ctx.clearRect(0,0,W,H);

    const p = 24 * devicePixelRatio;
    const x0 = p, y0 = p, x1 = W - p, y1 = H - p;

    ctx.strokeStyle = "rgba(255,255,255,.18)";
    ctx.lineWidth = 1 * devicePixelRatio;
    ctx.strokeRect(x0,y0,x1-x0,y1-y0);

    if(series.length < 2){
      ctx.fillStyle = "rgba(255,255,255,.6)";
      ctx.font = `${12*devicePixelRatio}px -apple-system,system-ui`;
      ctx.fillText("Pas assez de donn√©es", x0 + 10*devicePixelRatio, y0 + 22*devicePixelRatio);
      return;
    }

    const min = Math.min(...series);
    const max = Math.max(...series);
    const span = (max - min) || 1;
    const stepX = (x1-x0) / (series.length-1);

    ctx.beginPath();
    series.forEach((v,i)=>{
      const x = x0 + i*stepX;
      const y = y1 - ((v - min)/span) * (y1-y0);
      if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    });
    ctx.strokeStyle = color;
    ctx.lineWidth = 2.5 * devicePixelRatio;
    ctx.stroke();

    ctx.fillStyle = color;
    series.forEach((v,i)=>{
      const x = x0 + i*stepX;
      const y = y1 - ((v - min)/span) * (y1-y0);
      ctx.beginPath(); ctx.arc(x,y,3.5*devicePixelRatio,0,Math.PI*2); ctx.fill();
    });

    ctx.fillStyle = "rgba(255,255,255,.70)";
    ctx.font = `${11*devicePixelRatio}px -apple-system,system-ui`;
    ctx.fillText(labels[0] || "", x0, y1 + 18*devicePixelRatio);
    ctx.fillText(labels[labels.length-1] || "", x1 - 36*devicePixelRatio, y1 + 18*devicePixelRatio);
  }

  const block1 = document.createElement("div");
  block1.className = "card";
  block1.innerHTML = `<div class="cardTitle"><div><strong>Charge max</strong><div class="small">par s√©ance</div></div></div>`;
  block1.appendChild(c1);

  const block2 = document.createElement("div");
  block2.className = "card";
  block2.innerHTML = `<div class="cardTitle"><div><strong>Volume</strong><div class="small">somme (tous exercices)</div></div></div>`;
  block2.appendChild(c2);

  main.replaceChildren(wrap, block1, block2);

  setTimeout(()=>{
    drawLine(c1, maxW, "#7aa8ff");
    drawLine(c2, volumes, "#ffd36a");
  }, 50);
}

/** =========================
 *  Main render
 *  ========================= */
function render(){
  // Back-to-workout button: visible everywhere except workout
  toWorkoutBtn.style.display = (view === "workout") ? "none" : "inline-block";
  toWorkoutBtn.disabled = (view === "workout");

  // Toolbar hidden only in settings (keep in home/stats for export/import)
  document.getElementById("toolbar").style.display = (view === "settings") ? "none" : "flex";

  // Keep select in sync (show last/current session)
  const w = db.workouts.find(x => x.id === currentWorkoutId) || db.workouts[0];
  if(w && SESSIONS.includes(w.session)) sessionSelect.value = w.session;

  if(view === "home") renderHome();
  if(view === "workout") renderWorkout();
  if(view === "stats") renderStats();
  if(view === "settings") renderSettings();
}

// Start
render();

/** Service Worker registration (offline) */
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("./sw.js");
}
</script>
</body>
</html>
